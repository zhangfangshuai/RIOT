function refreshLang(){switch(APP.data.language){case"zh-cn":LANG=zhcn;break;case"en-us":LANG=enus;break;case"zh-tw":LANG=zhtw;break;default:LANG=enus}}function loadTag(e,t){if(0===e.indexOf("tags/"))return t();APP.tags.indexOf(e)>-1?t():riot.compile(e,function(){APP.tags.push(e),t()})}function timeOffset(){return(new Date).getTime()-APP.start}function addEvent(e,t){var n=e+(t||"");APP.events[n]||(APP.events[n]=[]),APP.events[n].push(timeOffset())}function setParam(e,t){APP.data[""+e]=t}function getParam(e){var t=APP.data[e];return t&&"null"!=t&&"undefined"!=t?t:""}function getUrlParam(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null}function popurl(){APP.count<9?APP.count++:(APP.count=0,msgBus.modalMsgBus.trigger("url"))}function tip(e,t){t&&(APP.error=e?t.interface+": "+e:t.interface+": -1"),msgBus.modalMsgBus.trigger("close"),msgBus.mainMsgBus.trigger("go","error")}function url(){return CONFIG.apis.base}function buildRequest(e,t,n,r,a){var o=new XMLHttpRequest;return o.open(e,t),n&&o.setRequestHeader("Content-Type","application/json;charset=utf-8"),r&&o.setRequestHeader("Authorization",getParam("auth")),o.timeout=5e3,o.ontimeout=function(e){"true"!=a.toString()&&e&&a&&a()("true"==a.toString())&&e&&(APP.error=LANG.neterr)&&tip(!1,!1)},o.onabort=function(e){"true"!=a.toString()&&e&&a&&a()("true"==a.toString())&&e&&(APP.error=LANG.neterr)&&tip(!1,!1)},o.onerror=function(e){"true"!=a.toString()&&e&&a&&a()("true"==a.toString())&&e&&(APP.error=LANG.neterr)&&tip(!1,!1)},o}function post_request(e,t,n){var r=n||1;if(getParam("auth")&&(new Date).getTime()<getParam("authTimeout")&&!getParam("tokenNeedRefresh"))console.log("auth_not_expired"),e&&e();else{var a=buildRequest("POST",url(),!0,!1,t);a.onload=function(){if(200==this.status){var n=JSON.parse(a.responseText);setParam("auth",n.token),setParam("authTimeout",1e3*n.expiresIn+(new Date).getTime()-5e3),e&&e()}else r<3?setTimeout(function(){auth(e,t,++r)},500):t&&function(e){tip(e,{interface:"1000","-1":"鉴权时网络异常,请检查后重试"})}(this.status)},a.send(JSON.stringify({postDatas:"postDatas"}))}}function get_request(e,t,n){var r=n||1,a=buildRequest("GET",url(),!1,!0,t);a.onload=function(){if(200==this.status){var n=JSON.parse(a.responseText);setParam("resp_info",n.resp_info),e&&e(n)}else r<3?setTimeout(function(){get_request(e,t,++r)},500):t&&(this.status,tip(e,{interface:"1001","-1":"发送get请求时网络异常，请检查后重试"}))},a.send()}function init(){console.log("Network reachable: "+APP.data.online),CONFIG.apis=APIS.default,msgBus.mainMsgBus.on("*",addEvent),msgBus.modalMsgBus.on("*",addEvent),msgBus.loadMsgBus.on("*",addEvent),riot.mixin(msgBus),riot.mount("*")}!function(e,t){var n=e.documentElement,r="orientationchange"in window?"orientationchange":"resize",a=function(){var e=n.clientWidth;e&&(n.style.fontSize=e<550?e/720*24+"px":e/1440*24+"px",refreshLang())};t.addEventListener(r,a,!1),e.addEventListener&&e.addEventListener("DOMContentLoaded",a,!1)}(document,window);var width="30rem",msgBus={mainMsgBus:riot.observable(),modalMsgBus:riot.observable(),loadMsgBus:riot.observable()},APP={data:{ua:navigator.userAgent,online:navigator.onLine,language:(navigator.browserLanguage||navigator.language).toLowerCase(),appVer:navigator.appVersion,h5Ver:"2.0.0"},start:(new Date).getTime(),tags:[],events:{},count:0,error:"",phoneFilter:/^1[34578][0-9]{9}$/},CONFIG={},CACHE={},PRD_CACHE=[],LANG={};refreshLang();var NetWorkListener={addHandler:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}};NetWorkListener.addHandler(window,"online",function(){console.log("网络连接正常"),msgBus.modalMsgBus.trigger("ball-loading"),window.location.reload()}),NetWorkListener.addHandler(window,"offline",function(){APP.error=LANG.neterr,tip(!1,!1)}),init();